---
title: "Building and visualizing pre-processing pipelines for flow cytometry data with CytoPipeline"
author:
  - Philippe Hauchamps ^[de Duve Institute, UCLouvain, philippe.hauchamps@uclouvain.be]
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{CytoPipeline Workshop}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  package.startup.message = FALSE,
  rmarkdown.html_vignette.check_title = FALSE,
  eval=TRUE)
```

```{r pkg, include = FALSE}
require(CytoPipelineGUI)
require(CytoPipelineUtils)
```

# Building and visualizing pre-processing pipelines for flow cytometry data with `CytoPipeline`

Authors:
    Philippe Hauchamps ^[de Duve Institute, UCLouvain].
    <br/>
Last modified: 18 August, 2023.

## Overview

### Description

This workshop provides a life example on how to build, run and visualize
flow cytometry data pre-processing pipelines, using the `CytoPipeline`
suite of packages.

### Pre-requisites

- Basic familiarity with flow cytometry (FC) data and data structures 
(e.g. flowCore::flowFrame)
- Interest in building automated data pre-processing pipelines 
for cytometry data
- Some knowledge about typical FC data pre-processing steps: compensation, 
scale transformation, quality control of signal stability in time, 
removal of un-desirable events, like doublets, debris, dead cells,etc.
A good overview article is (Liechti et al. 2021).


### Participation

The present `.Rmd` file  is designed to support, either an instructor-led live 
demo, or a lab format where participants run the example code on their own.  
Therefore it is up to you to decide how to spend your time during the
workshop, either by listening to the instructor, or by running the code chunks
one by one at your own pace, or a combination of both.

### _R_ / _Bioconductor_ packages used

- CytoPipeline (available in _Bioconductor°_ since 3.17)
- CytoPipelineGUI (submitted to _Bioconductor_, target version 3.18)
- CytoPipelineUtils (from public github repository)

### Time outline

| Activity                     | Time |
|------------------------------|------|
| Introduction                 | 10m  |
| Section 1                    | 15m  |
| Section 2                    | 10m  |
| Conclusion                   | 10m  |

### Workshop goals and objectives

* understand the basic concepts and infrastructure used by the `CytoPipeline`
suite of package.
* build and run a FC pre-processing pipeline using `CytoPipeline`, on a simple
example FC dataset.
* understand the added value of the visualization tools (`CYtoPipelineGUI`) 
for assessing the quality of the pipeline.

## Workshop


### Test
Test displaying version of all packages:

```{r tst, echo = FALSE, show = TRUE}
cat("CytoPipeline version:", as.character(packageVersion("CytoPipeline")))
cat("CytoPipelineGUI version:", as.character(packageVersion("CytoPipelineGUI")))
cat("CytoPipelineUtils version:", as.character(packageVersion("CytoPipelineUtils")))
```

### Introduction

#### Context

#### The example dataset

#### Target pipelines 


#### Essential CytoPipeline concepts


### Creating a CytoPipeline object


#### Step by step creation in R code


#### Centralizing the pipeline definition in a json file

```{r, step1}
rawDataDir <- "./rawData"
resultsDir <- 
    "./Results"

mySamples <- 
    file.path(rawDataDir, 
    c("D91_G01.fcs",
      "D93_C01.fcs"))


expName <- "CytoPipeline_Demo"


# 1.
jsonFile <- ("CytoPipeline_Demo_pipeline.json")

# creation of CytoPipeline object,
# using json file as input
pipL <- CytoPipeline(jsonFile, 
                     experimentName = expName,
                     sampleFiles = mySamples)

# display CytoPipeline object
pipL

plotCytoPipelineProcessingQueue(pipL, 
                                whichQueue = "pre-processing",
                                path = resultsDir,
                                sampleFile = 1)


```


### Executing and visualizing the pipeline run 

```{r, step2:with_errors}

# 2.

# execute pipeline
try(execute(pipL, path = resultsDir))

plotCytoPipelineProcessingQueue(pipL, 
                                whichQueue = "pre-processing",
                                path = resultsDir,
                                sampleFile = 1)


# launch shiny app
CytoPipelineGUI::CytoPipelineCheckApp(dir = resultsDir)

```

```{r, step2:ok}


jsonFile <- ("CytoPipeline_Demo_pipeline2.json")

# creation of CytoPipeline object,
# using json file as input
pipL <- CytoPipeline(jsonFile, 
                     experimentName = expName,
                     sampleFiles = mySamples)

# execute pipeline
try(execute(pipL, path = resultsDir))

plotCytoPipelineProcessingQueue(pipL, 
                                whichQueue = "pre-processing",
                                path = resultsDir,
                                sampleFile = 1)


# launch shiny app
CytoPipelineGUI::CytoPipelineCheckApp(dir = resultsDir)

```

```{r step3:nClust-2}

# 3.

# create pipeline with nClust = 2

expName <- "HBVT_Demo_2C"

jsonFile <- ("CytoPipeline_Demo_pipeline3.json")

pipL2 <- CytoPipeline(jsonFile,
                      experimentName = expName,
                      sampleFiles = mySamples)

plotCytoPipelineProcessingQueue(pipL2, 
                                whichQueue = "pre-processing",
                                path = resultsDir,
                                sampleFile = 1)

```



```{r, step3:execute}

# execute pipeline
execute(pipL2, path = resultsDir)

plotCytoPipelineProcessingQueue(pipL2, 
                                whichQueue = "pre-processing",
                                path = resultsDir,
                                sampleFile = 1)
```


``` {r, resultsViz}


# launch shiny app
CytoPipelineGUI::CytoPipelineCheckApp(dir = resultsDir)

```


### Comparing pipelines

```{r, step4}
# 4.
# creation of a new CytoPipeline object,
# using json file as input (flowAI)
pipL_flowAI <- CytoPipeline("CytoPipeline_Demo_pipeline_flowAI.json",
                            experimentName = "HBVT_Demo_flowAI",
                            sampleFiles = mySamples)

# display CytoPipeline object
pipL_flowAI

# execute pipeline
execute(pipL_flowAI, path = resultsDir)

plotCytoPipelineProcessingQueue(pipL_flowAI, 
                                whichQueue = "pre-processing",
                                path = resultsDir,
                                sampleFile = 1)

CytoPipelineGUI::CytoPipelineCheckApp(dir = resultsDir)
```


### Some technical flags

#### Cleaning the cache before running

```{r, step5a}
# 5a. execute pipeline with rmCache = TRUE

plotCytoPipelineProcessingQueue(pipL_flowAI, 
                                whichQueue = "pre-processing",
                                path = resultsDir,
                                sampleFile = 1)


execute(pipL_flowAI, path = resultsDir, rmCache = TRUE)
```

#### Running sample files in parallel

```{r, step5b}
# 5b. execute pipeline in parallel
bp <- BiocParallel::SnowParam(progressbar = TRUE)

execute(pipL_flowAI, path = resultsDir, rmCache = TRUE, useBiocParallel = TRUE,
        BPPARAM = bp,
        BPOPTIONS = BiocParallel::bpoptions(package = c("flowCore", 
                                                        "CytoPipelineUtils")))
```

### Visualization of scale transformations

```{r, step6}
# 6. show scale transformations
CytoPipelineGUI::ScaleTransformApp(dir = resultsDir)
```


# References

Emmaneel, Annelies, Katrien Quintelier, Dorine Sichien, Paulina Rybakowska, 
Concepción Marañón, Marta E. Alarcón-Riquelme, Gert Van Isterdael, 
Sofie Van Gassen, and Yvan Saeys. 2021. 
“PeacoQC: Peak-Based Selection of High Quality Cytometry Data.” 
Cytometry. Part A: The Journal of the International Society 
for Analytical Cytology, September. https://doi.org/10.1002/cyto.a.24501.

Liechti, Thomas, Lukas M. Weber, Thomas M. Ashhurst, Natalie Stanley, 
Martin Prlic, Sofie Van Gassen, and Florian Mair. 2021. 
“An Updated Guide for the Perplexed: Cytometry in the High-Dimensional Era.” 
Nature Immunology 22 (10): 1190–97.

Monaco, Gianni, Hao Chen, Michael Poidinger, Jinmiao Chen, 
João Pedro de Magalhães, and Anis Larbi. 2016. 
“flowAI: Automatic and Interactive Anomaly Discerning Tools 
for Flow Cytometry Data.” Bioinformatics  32 (16): 2473–80.

